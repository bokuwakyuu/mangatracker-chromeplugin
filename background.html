<html>
<head> 
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">

      display_domain = "mt.ecstaticblob.com";
      //display_domain = "localhost:9000";
      domain = "http://" + display_domain ;
      check_apikey_url = domain + "/checkapikey";
      addManga_url = domain + "/addmanga";
      myManga_url = domain + "/mymanga";

function action(a){

  return 
}

chrome.extension.onRequest.addListener( function (request, sender, sendResponse) {

  if(request.action == "add_manga"){
  	if(request.data["manga_name"] && request.data["chapter.issue"]){
  		request.data["api_key"] = localStorage["apikey"];
  		if(localStorage["apikey"]){
  			$.post(addManga_url, jQuery.param( request.data ),
  				function(data){
  					sendResponse({completed:true});
  				}
  			, "json");
  		}
  	}
  }

  if(request.action == "add_apikey"){
    if(request.data["force"] == false){
        sessionStorage["dont_update_key"] = true;
    }
    if(!sessionStorage["dont_update_key"]){
    $.post(check_apikey_url, jQuery.param( {api_key:request.data["key"]} ),
      function(user){
        console.log(user)
        if(!user.accepted){
          if(!localStorage["apikey"] || request.data["force"]){
            
              localStorage["apikey"] = request.data["key"];
        
            sendResponse({done:true});
          }else if(localStorage["apikey"] != request.data["key"]){
            sendResponse({not_matching:true});
          }
        }
      },"json");
  }
}
});


function focusOrCreateTab(url) {
  chrome.windows.getAll({"populate":true}, function(windows) {
    var existing_tab = null;
    for (var i in windows) {
      var tabs = windows[i].tabs;
      for (var j in tabs) {
        var tab = tabs[j];
        if (tab.url == url) {
          existing_tab = tab;
          break;
        }
      }
    }
    if (existing_tab) {
      chrome.tabs.update(existing_tab.id, {"selected":true});
    } else {
      chrome.tabs.create({"url":url, "selected":true});
    }
  });
}

chrome.browserAction.onClicked.addListener(function(tab) {
  //var manager_url = chrome.extension.getURL("api-key.html");
  focusOrCreateTab(myManga_url);
});


</script>
</head>
</html>

